function startRoulette() {
  if (spinning || !currentList.length) {
    alert('名簿がありません');
    return;
  }

  spinning = true;

  const sound = soundFiles[Math.floor(Math.random() * soundFiles.length)];
  audio = new Audio(baseUrl + sound);

  audio.addEventListener('loadedmetadata', () => {
    if (!currentList.length) {
      alert('名簿が空です（クラスが選ばれていない可能性）');
      spinning = false;
      return;
    }

    const duration = audio.duration;
    const totalSteps = 38;
    const baseInterval = (duration * 1000) / (totalSteps + 2);

    audio.play();

    let spins = 0;

    const step = () => {
      if (spins >= totalSteps) {
        // 騙しフェイント：一度止まって見せる
        setTimeout(() => {
          const fakeIdx = (currentIndex + currentList.length - 1) % currentList.length;
          document.getElementById('roulette').textContent = currentList[fakeIdx];

          // そしてもう一度だけ！
          setTimeout(() => {
            const selIdx = (fakeIdx + 1) % currentList.length;
            const selected = currentList[selIdx];
            document.getElementById('roulette').textContent = selected;
            document.getElementById('history').innerHTML += `<li>${selected}</li>`;

            if (!allowDuplicates) {
              currentList.splice(selIdx, 1);
            }

            currentIndex = 0;
            spinning = false;

            if (audio) {
              audio.pause();
              audio.currentTime = 0;
            }

            const el = document.getElementById("roulette");
            el.classList.add("highlight");
            rollCount++;

            if (rollCount % 5 === 0) {
              applySpecialEffect(el);
            }

            setTimeout(() => {
              el.classList.remove("highlight");
            }, 1000);

          }, 600); // 騙し後の本選出
        }, 400); // 騙しの止まり時間

        return;
      }

      // 通常の回転処理
      document.getElementById('roulette').textContent = currentList[currentIndex];
      currentIndex = (currentIndex + 1) % currentList.length;
      spins++;

      // 後半で減速演出
      let delay = baseInterval;
      if (spins > totalSteps * 0.7) {
        delay *= 1.6;
      } else if (spins > totalSteps * 0.5) {
        delay *= 1.3;
      }

      setTimeout(step, delay);
    };

    step(); // 回転スタート
  });
}
