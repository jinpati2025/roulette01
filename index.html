<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>学生ルーレット + 効果音</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f4f4f4; }
    #roulette { font-size: 48px; margin: 40px 0; height: 60px; }
    .highlight { color: crimson; font-weight: bold; font-size: 1.3em; animation: shake 0.3s; }
    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      50% { transform: translateX(5px); }
      75% { transform: translateX(-5px); }
      100% { transform: translateX(0); }
    }
  </style>
</head>
<body>
<h1>学生ルーレット + 効果音</h1>
<div id="class-buttons" class="class-buttons"></div>
<button id="toggle-duplicate" onclick="toggleDuplicate()">重複なし</button>
<div id="roulette">ルーレット中...</div>
<button onclick="startRoulette()">▶ スタート</button>

<div class="history">
  <h3>選ばれた学生:</h3><ul id="history"></ul>
</div>

<script>
let studentsByClass = {};
let currentClass = "";
let currentList = [];
let allowDuplicates = false;
let spinning = false;
let currentIndex = 0;
let intervalId;
let audio;

const isGitHub = location.hostname.includes("github.io");
const baseUrl = isGitHub ? "https://jinpati2025.github.io/roulette01/" : "./";

const soundFiles = [
  "01_roll_basic.mp3",
  "02_roll_impact.mp3",
  "03_roll_shiden.mp3",
  "04_fanfare_cheer.mp3",
  "05_fanfare_pokupoku.mp3",
  "06_voice_oujo.mp3",
  "07_voice_doragon.mp3"
];

function toggleDuplicate() {
  allowDuplicates = !allowDuplicates;
  document.getElementById("toggle-duplicate").textContent = allowDuplicates ? "重複あり" : "重複なし";
}

function renderClassButtons() {
  const box = document.getElementById('class-buttons');
  box.innerHTML = '';
  Object.keys(studentsByClass).forEach(k => {
    const btn = document.createElement('button');
    btn.textContent = k;
    btn.onclick = () => selectClass(k);
    box.appendChild(btn);
  });
}

function selectClass(k){
  currentClass = k;
  currentList = [...studentsByClass[k] || []];
  document.getElementById('history').innerHTML = '';
  document.getElementById('roulette').textContent = '名前がここに表示されます';
}

function startRoulette(){
  if (spinning || !currentList.length){
    alert('名簿がありません'); return;
  }
  spinning = true;

  const sound = soundFiles[Math.floor(Math.random() * soundFiles.length)];
  audio = new Audio(baseUrl + sound);
  audio.loop = true;
  audio.play();

  let speed = 100, slow = 0;
  intervalId = setInterval(()=>{
    document.getElementById('roulette').textContent = currentList[currentIndex];
    currentIndex = (currentIndex + 1) % currentList.length;
    if (++slow > 35){
      clearInterval(intervalId);
      setTimeout(()=>{
        const selIdx  = (currentIndex + currentList.length - 1) % currentList.length;
        const selected = currentList[selIdx];
        document.getElementById('roulette').textContent = selected;
        document.getElementById('history').innerHTML += `<li>${selected}</li>`;
        if (!allowDuplicates){ currentList.splice(selIdx,1); }
        currentIndex = 0; spinning = false;
        if (audio) {
          audio.pause();
          audio.currentTime = 0;
        }
        document.getElementById("roulette").classList.add("highlight");
        setTimeout(() => document.getElementById("roulette").classList.remove("highlight"), 1000);
      }, 200);
    }
  }, speed);
}

fetch("https://script.google.com/macros/s/AKfycbxgiJqg-mxOq-F4mdxYNoENdIX-75NdE1Dbi2wwqzDN1r4x2HxHAU_IQLiS3P92fXFD0Q/exec")
  .then(res => res.json())
  .then(data => {
    studentsByClass = data;
    const keys = Object.keys(data);
    if (keys.length > 0) {
      currentClass = keys[0];
      currentList = [...data[currentClass]];
    }
    renderClassButtons();
  })
  .catch(err => {
    console.error("名簿取得失敗:", err);
    alert("名簿が読み込めませんでした。ネットワークやアクセス設定を確認してください。");
  });
</script>
</body>
</html>
